#!/usr/bin/env zsh
# LLM RAG í¬ë¡  ì‘ì—… ê´€ë¦¬ CLI

# OpenClaw PATH ì¶”ê°€
export PATH="$HOME/.nvm/versions/node/v24.13.0/bin:$PATH"

CRON_HEALTHCHECK="82590edd-a405-426c-bb63-5463670c1e7a"
CRON_QA="8935609d-a8e9-49e0-a9e1-196730ea8771"
CRON_IMPROVE="04b96b52-b13f-4438-8900-6352ba70b8e1"

HEALTHCHECK_INTERVAL=300000  # 5ë¶„ (ê³ ì •)
IMPROVE_INTERVAL=3600000     # 1ì‹œê°„ (ê³ ì •)

usage() {
    cat << EOF
LLM RAG í¬ë¡  ì‘ì—… ê´€ë¦¬

ì‚¬ìš©ë²•:
  llmcron start [QAì£¼ê¸°_ë¶„]   # í¬ë¡  ì‹œì‘ (ê¸°ë³¸ 20ë¶„)
  llmcron stop                # í¬ë¡  ì¤‘ì§€
  llmcron status              # ìƒíƒœ í™•ì¸
  llmcron restart [QAì£¼ê¸°_ë¶„] # ì¬ì‹œì‘

ì˜ˆì‹œ:
  llmcron start 20      # QA 20ë¶„ë§ˆë‹¤ ì‹¤í–‰
  llmcron start 10      # QA 10ë¶„ë§ˆë‹¤ ì‹¤í–‰
  llmcron stop          # ëª¨ë“  í¬ë¡  ì¤‘ì§€
  llmcron status        # í˜„ì¬ ìƒíƒœ
EOF
}

status() {
    echo "ğŸ“Š LLM RAG í¬ë¡  ì‘ì—… ìƒíƒœ\n"
    openclaw cron list --json 2>/dev/null | python3 -c "
import sys, json
from datetime import datetime

data = json.load(sys.stdin)
for job in data.get('jobs', []):
    if 'LLM' not in job.get('name', ''):
        continue
    
    name = job['name']
    enabled = job['enabled']
    ms = job.get('schedule', {}).get('everyMs', 0)
    
    # ì£¼ê¸° ë³€í™˜
    if ms == 300000: interval = '5ë¶„'
    elif ms == 600000: interval = '10ë¶„'
    elif ms == 1200000: interval = '20ë¶„'
    elif ms == 1800000: interval = '30ë¶„'
    elif ms == 3600000: interval = '1ì‹œê°„'
    else: interval = f'{ms//60000}ë¶„'
    
    # ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„
    nextMs = job.get('state', {}).get('nextRunAtMs', 0)
    if nextMs:
        now = datetime.now().timestamp() * 1000
        diff = (nextMs - now) / 60000
        if diff < 0: nextStr = 'ì§€ë‚¨'
        elif diff < 1: nextStr = 'ê³§'
        elif diff < 60: nextStr = f'{int(diff)}ë¶„ í›„'
        else: nextStr = f'{diff/60:.1f}ì‹œê°„ í›„'
    else:
        nextStr = '-'
    
    status = 'âœ…' if enabled else 'âŒ'
    print(f'{status} {name} ({interval}ë§ˆë‹¤) - ë‹¤ìŒ: {nextStr}')
"
}

start() {
    local qa_interval=${1:-20}  # ê¸°ë³¸ 20ë¶„
    local qa_interval_ms=$((qa_interval * 60 * 1000))
    
    echo "ğŸš€ LLM RAG í¬ë¡  ì‘ì—… ì‹œì‘..."
    echo "   í—¬ìŠ¤ ì²´í¬: 5ë¶„ë§ˆë‹¤"
    echo "   QA í…ŒìŠ¤íŠ¸: ${qa_interval}ë¶„ë§ˆë‹¤"
    echo "   ìë™ ê°œì„ : 1ì‹œê°„ë§ˆë‹¤\n"
    
    # í—¬ìŠ¤ ì²´í¬ í™œì„±í™”
    openclaw cron update $CRON_HEALTHCHECK --enabled true > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo "âœ… í—¬ìŠ¤ ì²´í¬ í™œì„±í™”"
    else
        echo "âš ï¸ í—¬ìŠ¤ ì²´í¬ í™œì„±í™” ì‹¤íŒ¨ (í¬ë¡ ì´ ì—†ì„ ìˆ˜ ìˆìŒ)"
    fi
    
    # QA í…ŒìŠ¤íŠ¸ ì£¼ê¸° ì„¤ì • ë° í™œì„±í™”
    openclaw cron update $CRON_QA \
        --schedule "{\"kind\":\"every\",\"everyMs\":$qa_interval_ms}" \
        --enabled true > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo "âœ… QA í…ŒìŠ¤íŠ¸ í™œì„±í™” (${qa_interval}ë¶„ë§ˆë‹¤)"
    else
        echo "âš ï¸ QA í…ŒìŠ¤íŠ¸ í™œì„±í™” ì‹¤íŒ¨"
    fi
    
    # ìë™ ê°œì„  í™œì„±í™”
    openclaw cron update $CRON_IMPROVE --enabled true > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo "âœ… ìë™ ê°œì„  í™œì„±í™”"
    else
        echo "âš ï¸ ìë™ ê°œì„  í™œì„±í™” ì‹¤íŒ¨"
    fi
    
    echo "\nâœ… í¬ë¡  ì‘ì—… ì‹œì‘ ì™„ë£Œ\n"
    status
}

stop() {
    echo "â¸ï¸  LLM RAG í¬ë¡  ì‘ì—… ì¤‘ì§€...\n"
    
    openclaw cron update $CRON_HEALTHCHECK --enabled false > /dev/null 2>&1
    [ $? -eq 0 ] && echo "â¸ï¸  í—¬ìŠ¤ ì²´í¬ ì¤‘ì§€"
    
    openclaw cron update $CRON_QA --enabled false > /dev/null 2>&1
    [ $? -eq 0 ] && echo "â¸ï¸  QA í…ŒìŠ¤íŠ¸ ì¤‘ì§€"
    
    openclaw cron update $CRON_IMPROVE --enabled false > /dev/null 2>&1
    [ $? -eq 0 ] && echo "â¸ï¸  ìë™ ê°œì„  ì¤‘ì§€"
    
    echo "\nâœ… í¬ë¡  ì‘ì—… ì¤‘ì§€ ì™„ë£Œ\n"
    status
}

restart() {
    echo "ğŸ”„ í¬ë¡  ì‘ì—… ì¬ì‹œì‘...\n"
    stop
    echo ""
    sleep 1
    start $1
}

case "$1" in
    start)
        start $2
        ;;
    stop)
        stop
        ;;
    status)
        status
        ;;
    restart)
        restart $2
        ;;
    *)
        usage
        exit 1
        ;;
esac
