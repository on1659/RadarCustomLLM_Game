# 2026-02-17 작업 로그

## 작업 개요
- 작업 시간: 11:30 ~ 12:05 (KST)
- 목표: RAG QA 실패 항목 수정 (팰월드 아누비스, 마크 엔더드래곤)
- 결과: QA 통과율 2/4 → 4/4 (100%)

---

## 타임라인

### 11:30 — QA baseline 확인
수정 전 4개 테스트 결과:

| 질문 | 결과 | 소스 | 문제점 |
|---|---|---|---|
| 오버워치 겐지 | ✅ | 겐지(오버워치) | 정상 |
| 팰월드 아누비스 | ❌ "잘 모르겠어요" | - | 아누비스 데이터 파일 자체가 없음 |
| 마크 엔더드래곤 | ❌ 엔더맨 농사 정보 반환 | 마인크래프트_농사 | 엔더드래곤 문서 없음 + 잘못된 문서 검색 |
| 아누비스 (역질문) | ✅ | - | 게임 선택 버튼 정상 |

### 11:35 — 데이터 추가
- **엔더 드래곤**: 나무위키 `엔더 드래곤` 페이지 크롤링 (13,773자)
  - `crawler/data/minecraft/마인크래프트_엔더드래곤.txt`
- **아누비스**: 나무위키에 개별 문서 없음 → palworld.gg 영어 데이터 기반 한국어 수동 생성
  - `crawler/data/palworld/pal_anubis.txt`
  - 기본 정보, 스탯, 스킬, 드롭, 작업 적성, 교배 조합 포함

### 11:40 — FAISS DB 리빌드 (1차)
- `ingest.py` 실행 → 4,064 → 4,090 chunks
- RAG 서버 재시작
- 테스트: 아누비스 ❌, 엔더드래곤 ❌ — 여전히 실패
- 원인: **실행 중인 서버가 이전 FAISS DB를 메모리에 캐싱**하고 있었음

### 11:43 — FAISS 직접 디버그 테스트
```
"팰월드 아누비스" → FAISS 1위: pal_anubis ✅
"마크 엔더드래곤" → FAISS 2위: 마인크래프트_엔더드래곤 ✅
```
→ 데이터는 FAISS에 들어갔지만 웹서버가 옛 인덱스 사용 중

### 11:45 — 서버 재시작 후 재테스트
- 아누비스: ✅ "에픽 등급 땅 속성 팰, HP 120, 방어력 100" — 정확!
- 엔더드래곤: ❌ "잘 모르겠어요" (소스는 `마인크래프트_농사`)
- 원인 분석: **검색 결과에서 엔더드래곤 문서가 아닌 농사 문서가 상위**에 옴

### 11:47 — 벡터 검색 분석
```
"엔더 드래곤" (띄어쓰기) → ✅ top3 전부 엔더드래곤
"엔더드래곤" (붙여쓰기) → ❌ 바이옴, 농사, astegon
"마인크래프트 엔더드래곤" → ❌ 팁, 몹, 레드스톤
```
→ **한국어 붙여쓰기가 벡터 임베딩 유사도를 크게 떨어뜨림**

### 11:48 — 수정 1: 쿼리 동의어 매핑 추가
`QUERY_SYNONYMS` 딕셔너리 추가 (web.py):
- "엔더드래곤" → "엔더 드래곤"
- "엔더진주" → "엔더 진주"
- "위더스켈레톤" → "위더 스켈레톤" 등
- 벡터/BM25 검색 전 `search_query`로 변환

### 11:49 — 나무위키 데이터 정리
엔더드래곤 크롤링 파일에 네비게이션 목록(몹 리스트), 광고, footer가 대량 포함됨:
- 정리 전: 13,773자 (앞부분이 몹 네비게이션으로 가득)
- 정리 후: 11,169자 (스탯 + 개요 + 패턴 + 공략법 + 여담만)

### 11:51 — FAISS DB 리빌드 (2차)
- 4,064 → 4,084 chunks
- 서버 재시작 + 테스트
- 소스: `마인크래프트_엔더드래곤` ✅ (올바른 문서)
- 답변: ❌ "잘 모르겠어요" — 소스는 맞는데 답변 생성 실패

### 11:53 — LLM 직접 테스트로 원인 특정
llama-server에 동일 context + 다른 질문 형태로 직접 테스트:
```
"엔더드래곤이 뭐야?" → ✅ "마인크래프트의 최종 보스 격인 비행형 몬스터..."
"마크 엔더드래곤"    → ❌ "잘 모르겠어요"
```
→ **3B 모델은 키워드만 던지면 "뭘 물어보는지 모르겠다"로 판단**
→ 질문 형태일 때만 정상 답변

### 11:55 — 수정 2: 질문형 자동 보정
"?", "뭐", "알려", "설명" 등 질문 마커가 없으면 자동으로 `"에 대해 알려줘"` 추가:
```python
if not any(m in query for m in question_markers):
    llm_query = f"{query}에 대해 알려줘"
```

### 11:56 — 수정 3: Context 품질 개선
- chunk 크기: 400자 → 600자 (더 많은 맥락 제공)
- context에 `[문서제목]` 헤더 추가 → 모델이 출처 구분 가능
- n_predict: 120 → 200 (답변 잘림 방지)
- 5개 결과 시도 → 400 에러 (프롬프트 초과) → 3개로 복원

### 12:00 — 수정 4: 테스트 질문 변경
이더 요청: 성공한 질문(겐지)은 비슷한 류의 새로운 걸로 변경
- 겐지 → **한조**로 교체

### 12:03 — 최종 QA 테스트 (수정 후)

| 질문 | 결과 | 소스 | 답변 요약 |
|---|---|---|---|
| 마크 엔더드래곤 | ✅ | 마인크래프트_엔더드래곤 | "최종 보스 비행형 몬스터, 1마리만 생성, 평화로움에서도 안 사라짐" |
| 팰월드 아누비스 | ✅ | pal_anubis, 팰월드 | "에픽등급 땅 속성, HP 120, 파트너스킬 사막의 수호자" |
| 오버워치 한조 | ✅ | 한조(오버워치) | "궁수와 암살자 능력 갖춘 영웅, 냉병기 사용" |
| 아누비스 (역질문) | ✅ | - | 게임 선택 버튼 (오버워치, 팰월드) |

**결과: 2/4 → 4/4 (100% 통과)**

### 12:04 — Git push
- commit `0473a6b`: 코드 변경 + 데이터 추가
- commit `1fd1133`: 로그 시간 추가

---

## 변경된 파일
| 파일 | 변경 내용 |
|---|---|
| `rag/web.py` | 동의어 매핑, 질문 자동보정, chunk 600자, context 제목, n_predict 200 |
| `rag/faiss_db/` | 리빌드 (4084 chunks) |
| `crawler/data/minecraft/마인크래프트_엔더드래곤.txt` | 신규 (나무위키 크롤링 + 정리) |
| `crawler/data/palworld/pal_anubis.txt` | 신규 (수동 생성, 한국어) |
| `log.md` | 인덱스 업데이트 |
| `logs/2026-02-17_log.md` | 본 파일 |

## 분석 및 수정 방향

### 발견된 3가지 패턴
1. **데이터 부재** → 해당 팰/몹 문서가 없으면 당연히 답변 불가. 데이터 추가로 해결.
2. **벡터 검색의 한국어 약점** → 붙여쓰기("엔더드래곤")와 띄어쓰기("엔더 드래곤")가 완전히 다른 벡터로 인식됨. 동의어 매핑으로 해결했지만, 게임 용어 사전 확장 필요.
3. **3B 모델의 프롬프트 민감성** → context에 정답이 있어도 질문이 키워드뿐이면 답변 거부. 자동 보정으로 해결했지만, 더 큰 모델(7B+)이면 이 문제 없을 가능성.

### 향후 개선 방향
- 게임 용어 동의어 사전 확장 (더 많은 붙여쓰기 패턴)
- palworld.gg 인코딩 깨짐 재크롤링
- 3B → 7B 모델 전환 검토 (16GB 제한 내)
- training data 500+ 확장으로 `<think>` 태그 활성화
- Minecraft/Overwatch 추가 문서 크롤링
