========================================
## 2026-02-17 02:20 — 7B 모델 전환 & 답변 품질 대폭 개선
========================================

### 문제점 (3B 모델)
1. **같은 말 3번 반복** — "일본계 영웅, 벽투시의 암살자 궁수"를 여러 번 말함
2. **역할 혼동** — "당신은 게임 위키도우미 입니다?" ← 시스템 프롬프트를 따라하며 헷갈림
3. **중국어 전환** — 한국어 답변 중 갑자기 中文으로 넘어감
4. **RAG 내부 태그 노출** — `[palworld - pal_azurobe]` 같은 태그가 답변에 그대로 노출
5. **stop 토큰 부족** — 반복/언어전환/코드블록 생성을 못 막음

### 해결 1: 모델 업그레이드 (3B → 7B)
- **변경 전:** Qwen2.5-3B-Instruct Q4_K_M (1.93GB)
- **변경 후:** Qwen2.5-7B-Instruct Q4_K_M (4.4GB)
- bartowski 양자화 버전 (imatrix 적용)
- 다운로드: huggingface.co/bartowski/Qwen2.5-7B-Instruct-GGUF
- 메모리: ~5GB 사용 (16GB 맥미니에서 여유 있음)
- 속도: ~21 토큰/초 (3B의 절반 정도지만 충분히 사용 가능)

### 해결 2: 프롬프트 전면 개편
- **변경 전:** 격식체 + 길고 복잡한 규칙
- **변경 후:** 반말 + 짧고 명확한 지시
  ```
  너는 게임 정보를 알려주는 한국어 도우미야.
  아래 참고 자료를 바탕으로 질문에 짧게 답해.
  모르면 "잘 모르겠어요"라고만 해. 지어내지 마.
  반드시 한국어로만 답해. 중국어, 영어, 일본어 사용 금지.
  참고 자료의 태그나 코드를 답변에 포함하지 마.
  ```
- context에서 `[game - title]` 태그 제거 → 모델이 복사하지 못하게

### 해결 3: LLM 파라미터 재조정
- `n_predict`: 150 → 120 (더 짧게 끊음)
- `temperature`: 0.1 → 0.05 (거의 deterministic)
- `repeat_penalty`: 1.8 → 1.3 (1.8은 너무 높아서 이상한 토큰 유발)
- `frequency_penalty`: 0.5 → 제거 (repeat_penalty와 중복)
- stop 토큰: `["\n\n", "질문:", "참고:", "---", "\`\`\`", "[", "根据", "抱歉", "Sorry"]`

### 해결 4: 답변 후처리 (clean_answer)
- 중국어/일본어 문자 감지 → 그 앞까지만 잘라냄
- 내부 태그 `[game/title]` 제거
- 코드블록 제거
- 반복 문장 제거 (문장별 해시 비교)
- 문장 끝이 어중간하면 마지막 완전한 문장까지만

### 테스트 결과
| 질문 | 3B (이전) | 7B (개선 후) |
|------|-----------|-------------|
| 오버워치 한조 누구야 | 같은 말 3번 반복 + "당신은 게임 위키도우미?" | "시마다 한조는 궁수와 암살자로서의 기술을 연마한 영웅입니다. 냉병기만 사용합니다." ✅ |
| 마크 다이아몬드 캐는법 | 깨진 인코딩 + 중국어 | "내구성 III 이상의 곡괭이 필요, 침대 폭파나 보루 잔해 상자 추천" ✅ |
| 팰월드 물 종결펠 | "Cobalt Dusk(钴蓝暮光)" 완전 창작 | "Azurobe Lady of the Lake" ⚠️ (영어 섞임 — 크롤링 데이터가 영어) |

### 남은 이슈
- ⚠️ **팰월드 데이터 영어 문제** — palworld.gg가 영어 사이트라 크롤링 데이터 자체가 영어. 답변에 영어가 섞임. 한국어 위키(나무위키) 팰월드 하위문서 크롤링으로 해결 필요
- ⚠️ **BM25 인덱스 구축 느림** — 서버 시작 후 첫 요청에 2~3분 소요 (4064개 문서 × 바이그램 토크나이징). 서버 시작 시 미리 로드하도록 변경 필요

### 수정된 파일
- `rag/web.py` — 프롬프트, LLM 파라미터, 후처리, 모바일 UI
- `skills/llm-server/scripts/start.sh` — 7B 모델 경로로 변경

---

========================================
## 2026-02-17 00:28 — 대화 세션 기능 (GPT 스타일)
========================================

### 추가된 기능
- 🗂️ **왼쪽 사이드바** — 대화 목록 + "새 대화" 버튼
- 💾 **SQLite 저장** — `rag/chat.db`에 영구 저장 (서버 재시작해도 유지)
- 🗑️ **/clear** — 입력창에 치거나 우측 상단 버튼으로 컨텍스트 초기화
- ❌ **대화 삭제** — 사이드바에서 × 클릭
- 📝 **대화 제목** — 첫 질문 기반 자동 생성
- 🔄 **이전 대화 컨텍스트** — 최근 4개 메시지를 LLM에 전달

### DB 스키마
- `sessions` 테이블: id, title, created_at, updated_at
- `messages` 테이블: session_id, role, content, sources, created_at

### API 엔드포인트
- `GET /api/sessions` — 세션 목록
- `POST /api/sessions` — 새 세션
- `GET /api/sessions/:id/messages` — 메시지 조회
- `POST /api/sessions/:id/clear` — 컨텍스트 초기화
- `DELETE /api/sessions/:id` — 세션 삭제
- `POST /api/chat` — 채팅 (session_id 포함)

---

========================================
## 2026-02-17 00:36 — 실시간 테마 변경 시스템
========================================

### 추가된 기능
- 🎨 헤더 우측 테마 버튼 → 컬러피커 패널
- 4개 컬러 변수로 전체 UI 제어 (CSS 변수)
- 프리셋: 🍑 웜톤, 🌿 세이지, 🌙 다크, ☕ 베이지, 🧊 블루
- localStorage로 테마 저장 (새로고침해도 유지)
- 다크/라이트 모드 자동 전환 (밝기 감지)

---

========================================
## 2026-02-17 03:05 — 모바일 반응형 UI
========================================

### 변경사항
- 사이드바 → 숨김 (왼쪽에서 슬라이드 인/아웃)
- ☰ 햄버거 메뉴 버튼 추가
- ✕ 닫기 + 오버레이 터치로 닫기
- 채팅 버블 컴팩트화 (패딩, 폰트, 마진 축소)
- 입력 영역 모바일 최적화

---
