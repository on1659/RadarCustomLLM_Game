# 2026-02-17 작업 로그

## 작업 개요
- 작업 시간: 11:30 ~ 12:10 (KST)
- 목표: RAG QA 실패 항목 수정 (팰월드 아누비스, 마크 엔더드래곤)
- 결과: QA 통과율 2/4 → 4/4 (100%)

---

## 진행 과정

### 11:30 — 문제 진단 시작

수정 전 baseline QA 4개:
- 겐지 ✅, 아누비스 ❌, 엔더드래곤 ❌, 역질문 ✅

아누비스가 왜 실패하는지 확인했더니 `crawler/data/palworld/` 디렉토리에 아누비스 전용 파일이 아예 없었음.
나무위키에도 팰월드 아누비스 개별 문서가 없고, palworld.gg 크롤링 데이터는 인코딩이 깨진 상태(Ã©, ð 문자).

엔더드래곤도 마찬가지로 `crawler/data/minecraft/`에 전용 문서 없음. 나무위키 크롤러가 해당 페이지를 못 가져온 것.

**→ 둘 다 데이터 자체가 없어서 RAG가 답을 못 한 거였음. 단순한 문제.**

### 11:35 — 데이터 수동 생성/크롤링

**엔더 드래곤**: 나무위키 `엔더 드래곤` 페이지를 직접 크롤링. 13,773자 저장.

**아누비스**: 나무위키에 문서가 없어서 palworld.gg 영문 페이지를 참고해 한국어로 직접 작성.
스탯, 스킬, 드롭, 작업 적성, 교배 조합 등을 수동 번역. 인코딩 깨진 기존 데이터 쓸 수 없어서 이 방법을 택함.

### 11:40 — FAISS 리빌드 후 첫 테스트 → 실패

`ingest.py`로 FAISS DB 리빌드 (4,064 → 4,090 chunks).
서버 재시작 후 테스트했는데 **두 개 다 여전히 실패**.

여기서 좀 헤맸음. 데이터를 넣었는데 왜 안 되지?

### 11:43 — FAISS를 직접 열어서 디버그

혹시 ingest가 제대로 안 됐나 의심해서 파이썬으로 FAISS DB를 직접 로드해 similarity_search 테스트:
```
"팰월드 아누비스" → 1위: pal_anubis ✅
"마크 엔더드래곤" → 2위: 마인크래프트_엔더드래곤 ✅
```

FAISS에는 제대로 들어가 있었음. 그러면 문제는 **웹서버(web.py) 쪽**.

생각해보니 web.py가 시작할 때 FAISS와 BM25 인덱스를 메모리에 로드하는데, 이전에 kill하고 재시작한 게 제대로 안 됐거나 BM25 인덱스가 갱신 안 됐을 수 있음. 프로세스를 확실히 죽이고 다시 시작.

### 11:45 — 재시작 후 아누비스 성공, 엔더드래곤은 여전히 실패

- **아누비스 ✅**: "에픽 등급 땅 속성 팰, HP 120, 방어력 100" — 드디어 제대로 답함!
- **엔더드래곤 ❌**: "잘 모르겠어요" — 그런데 소스를 보니 `마인크래프트_농사`가 나옴. 엔더드래곤 문서가 아니라 농사 문서에서 "엔더" 키워드가 걸린 것.

왜 엔더드래곤 문서가 검색 상위에 안 오지? FAISS 직접 테스트에선 나왔는데?

### 11:47 — 한국어 붙여쓰기 문제 발견 (핵심)

벡터 검색을 쿼리별로 비교 테스트해봄:
```
"엔더 드래곤" (띄어쓰기) → top3 전부 엔더드래곤 문서 ✅
"엔더드래곤" (붙여쓰기) → 바이옴, 농사, astegon ❌
"마인크래프트 엔더드래곤" → 팁, 몹, 레드스톤 ❌
```

**사용자가 "엔더드래곤"으로 붙여 쓰는데, 문서에는 "엔더 드래곤"으로 띄어쓰기 되어 있어서 벡터 임베딩 유사도가 완전히 달라지는 것**. ko-sroberta가 형태소 분석 없이 서브워드 토크나이징을 하기 때문에, 붙여쓰면 아예 다른 토큰으로 인식됨.

11:43의 FAISS 직접 테스트에서 "팰월드 아누비스"가 잘 나온 건 "아누비스"가 원래 한 단어라 붙여쓰기 문제가 없었고, "엔더드래곤"이 2위로 나온 건 약간의 유사도가 있었지만 web.py의 하이브리드 검색 + 게임 필터 조합에서 밀려난 것.

### 11:48 — 수정 1: 동의어 매핑

`QUERY_SYNONYMS` 딕셔너리를 만들어서 검색 전에 변환하도록 함:
```python
"엔더드래곤" → "엔더 드래곤"
"위더스켈레톤" → "위더 스켈레톤"
```
search_query를 벡터/BM25 양쪽에 모두 적용.

### 11:49 — 크롤링 데이터 오염 발견

동의어 매핑 적용 후 소스는 `마인크래프트_엔더드래곤`으로 바뀌었지만 여전히 "잘 모르겠어요".

검색된 chunk 내용을 확인해봤더니 나무위키 크롤링 데이터가 문제. 파일 앞부분이 **몹 네비게이션 리스트**(돼지, 양, 소, 무시룸... 수백 개 몹 이름 나열)로 도배되어 있고, 뒷부분은 **광고**(산후도우미, SMMA아카데미, 배달대행...).

실제 엔더드래곤 본문은 파일 중간에 묻혀 있었음.

파이썬으로 정리: 네비게이션/광고/footer 제거. 13,773자 → 11,169자.

### 11:51 — FAISS 2차 리빌드 + 여전히 실패

정리된 데이터로 리빌드 (4,084 chunks). 서버 재시작.

소스가 `마인크래프트_엔더드래곤`으로 올바르게 잡힘 ✅
그런데 답변은 여전히 **"잘 모르겠어요"** ❌

소스(검색)는 맞는데 답변(LLM)이 틀리다? 검색 문제가 아니라 **LLM 생성 쪽 문제**라는 뜻.

### 11:52 — 실제 전달되는 context 확인 시도 (삽질)

"모델한테 뭐가 전달되는 거지?" 싶어서 web.py에 `print(f"[DEBUG] prompt length: ... context preview: ...")` 로그를 추가.

서버 재시작 후 테스트 → `/tmp/rag_web.log`에서 `grep DEBUG` 했는데 **아무것도 안 나옴**. `print`가 stdout으로 가는데 nohup으로 리다이렉트한 로그 파일에 안 찍힌 것. 왜 안 나오지 하고 한참 기다림.

`print(..., file=sys.stderr)`로 바꿔봄 → 이번엔 나옴. `[DEBUG] prompt length: 2015 chars, context length: 1851 chars`. 근데 context preview가 빈 줄로 시작해서 내용 확인이 안 됨.

결국 `with open("/tmp/rag_debug_prompt.txt", "w") as f: f.write(prompt)` 로 전체 프롬프트를 파일에 저장하는 방식으로 바꿈.

### 11:53 — 프롬프트 파일 확인 → context는 정상

`/tmp/rag_debug_prompt.txt` 열어보니 context에 엔더드래곤 정보가 3개 chunk로 제대로 들어가 있었음:
- chunk 1: 여담 (바운딩 박스, 피스톤)
- chunk 2: 스탯 + 개요 ("최종 보스 비행형 몬스터")  
- chunk 3: 여담 (히트박스, 엔더맨 관계)

context 자체는 문제 없음. 그러면 왜 "잘 모르겠어요"?

### 11:54 — LLM 직접 테스트로 원인 특정

web.py를 거치지 않고 llama-server `/completion` API에 직접 같은 context를 넣고 **질문 형태만 바꿔봄**:

```
context: "엔더 드래곤 ... 마인크래프트의 최종 보스 ..."
질문: "엔더드래곤이 뭐야?" → ✅ "마인크래프트의 최종 보스 격인 비행형 몬스터..."
질문: "마크 엔더드래곤"    → ❌ "잘 모르겠어요. 질문의 의도가 명확하지 않아..."
```

**같은 context인데 질문 형태에 따라 결과가 완전히 달라짐.** "마크 엔더드래곤"은 질문이 아니라 키워드일 뿐이라서 3B 모델이 "뭘 물어보는 건지 모르겠다"로 판단한 것. 모델이 직접 "질문의 의도가 명확하지 않아"라고 말해줘서 바로 확인됨.

시스템 프롬프트에 "모르면 잘 모르겠어요라고만 해"가 있어서, 모델이 질문 의도를 파악 못 하면 안전하게 "잘 모르겠어요"로 빠지는 거였음. **프롬프트 설계 문제.**

### 11:55 — 수정 2: 질문형 자동 보정

사용자 쿼리에 "?", "뭐", "알려", "설명", "어떻게" 등 질문 마커가 없으면 자동으로 "에 대해 알려줘"를 붙여서 LLM에 전달:
```python
if not any(m in query for m in question_markers):
    llm_query = f"{query}에 대해 알려줘"
```

검색은 원본 쿼리(search_query)로, LLM 생성은 보정 쿼리(llm_query)로 분리.

### 11:56 — 수정 3: Context 품질 개선 (시행착오)

질문 보정이 핵심이었지만 context도 개선하려고 이것저것 시도:

1. **chunk 400→600자**: context에 더 많은 맥락을 주면 모델이 이해 잘 할 거라 생각.
2. **검색 결과 3→5개**: 더 많은 chunk를 보여주면 정보가 풍부해질 거라 생각.
   → 5개×600자 = 3000자 + 시스템 프롬프트 → **llama-server가 400 Bad Request 반환.** `-c 4096` 토큰 제한 초과. "이것도 되나?" 싶어서 해봤는데 역시 안 됨.
   → 다시 3개로 복원. 3×600 = 1800자는 괜찮음.
3. **context에 `[문서제목]` 헤더 추가**: chunk 앞에 `[마인크래프트_엔더드래곤]`처럼 제목을 붙임. 모델이 "이건 엔더드래곤 관련 문서구나" 파악하는 데 도움 될 거라 판단.
4. **n_predict 120→200**: 이전에 아누비스 답변이 중간에 잘린 적 있어서 늘림.

### 12:00 — 이더 요청: 테스트 질문 변경

이더가 "성공한 건 비슷한 류의 새로운 걸로 바꾸라"고 해서 겐지(✅) → **한조**로 교체.

### 12:03 — 최종 전체 테스트

4개 전부 돌림:

| 질문 | 결과 | 답변 핵심 |
|---|---|---|
| 마크 엔더드래곤 | ✅ | "최종 보스 비행형 몬스터, 1마리만 생성" |
| 팰월드 아누비스 | ✅ | "에픽등급 땅 속성, HP 120, 파트너스킬 사막의 수호자" |
| 오버워치 한조 | ✅ | "궁수와 암살자 능력 갖춘 영웅" |
| 아누비스 역질문 | ✅ | 게임 선택 버튼 (오버워치, 팰월드) |

### 12:04 — Git push
- `0473a6b`: 전체 변경사항
- `1fd1133`: 로그 시간 추가
- `c3a5510`: 로그 재작성

---

## 변경된 파일
| 파일 | 변경 내용 |
|---|---|
| `rag/web.py` | QUERY_SYNONYMS, 질문 자동보정, chunk 600자, context [제목], n_predict 200 |
| `rag/faiss_db/` | 리빌드 (4,084 chunks) |
| `crawler/data/minecraft/마인크래프트_엔더드래곤.txt` | 신규 — 나무위키 크롤링 + 네비/광고 제거 |
| `crawler/data/palworld/pal_anubis.txt` | 신규 — palworld.gg 기반 한국어 수동 작성 |

## 이번에 배운 것

1. **ko-sroberta 임베딩은 붙여쓰기에 약하다.** "엔더드래곤"과 "엔더 드래곤"이 완전히 다른 벡터. 한국어 RAG에서는 동의어 매핑이 필수.

2. **3B 모델은 질문 의도 파악이 약하다.** context에 정답이 있어도 "마크 엔더드래곤"처럼 키워드만 던지면 답변 거부. 7B+ 모델이면 이 정도는 알아서 처리할 듯.

3. **나무위키 크롤링 데이터는 반드시 정리 필요.** 네비게이션, 광고, footer가 본문의 30~50%를 차지. chunk에 쓰레기가 섞이면 모델이 혼란.

4. **디버깅은 단계를 쪼개야 한다.** "검색이 문제인지 vs LLM 생성이 문제인지"를 구분하는 게 핵심이었음. FAISS 직접 테스트 → 검색 OK 확인 → LLM 직접 테스트 → 프롬프트 문제 확인.

## 향후 방향
- 동의어 사전 확장 (게임 용어 붙여쓰기 패턴)
- palworld.gg 인코딩 깨짐 재크롤링
- 나무위키 크롤러에 네비/광고 자동 제거 로직 추가
- 3B → 7B 모델 전환 검토 (16GB 메모리 내)
